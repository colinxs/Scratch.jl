using JSync
using Random

function randpath(parent, n=10; delay=0.001)
    cur = parent
    for i=1:n
        dir = rand(Bool)
        path = joinpath(cur, randstring(5))
        if dir
            cur = mkdir(path)
        else
            touch(path)
        end
        sleep(delay)
    end
end

function paths(path)
    x=String[]
    for (r, ds, fs) in walkdir(path)
        for d in ds
            push!(x, joinpath(r, d))
        end
        for f in fs
            push!(x, joinpath(r, f))
        end
    end
    return x
end


function reader(tw)
    known = Set()
    t = time()
    while isopen(tw)
        x = take!(tw)
        if x isa JSync.TreeEvent
            push!(known, x.path)
        else
            for ev in x
                push!(known, ev.path)
            end
        end
        println("---------- ($(length(known))/$(length(paths("/tmp/test"))) ----------")
    end
end

function main()
    rm("/tmp/test", recursive=true, force=true)
    mkdir("/tmp/test")

    tw = JSync.watch_tree("/tmp/test", max_delay=1)
    # tw = JSync.watch_tree("/tmp/test")
    # @info typeof(tw)
    @async reader(tw)
    tw
end
    
